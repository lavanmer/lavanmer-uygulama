import streamlit as st
import pandas as pd
import sqlite3
from datetime import datetime

# --- VERÄ°TABANI AYARLARI ---
def init_db():
    conn = sqlite3.connect('lavanta_maliye.db')
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS islemler
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                  tarih DATE,
                  tip TEXT,
                  kategori TEXT,
                  odeme_yontemi TEXT,
                  tutar REAL,
                  aciklama TEXT)''')
    conn.commit()
    return conn

# --- UYGULAMA ARAYÃœZÃœ ---
st.set_page_config(page_title="Lavanta BahÃ§esi Takip", layout="centered")
st.title("ğŸª» Lavanta BahÃ§esi Mali Takip")

conn = init_db()

menu = ["Yeni KayÄ±t Ekle", "Mali Raporlar", "KayÄ±tlarÄ± DÃ¼zenle"]
choice = st.sidebar.selectbox("MenÃ¼", menu)

if choice == "Yeni KayÄ±t Ekle":
    st.subheader("â• Yeni Ä°ÅŸlem GiriÅŸi")
    
    with st.form("islem_formu", clear_on_submit=True):
        col1, col2 = st.columns(2)
        with col1:
            tarih = st.date_input("Ä°ÅŸlem Tarihi", datetime.now())
            tip = st.selectbox("Ä°ÅŸlem Tipi", ["Gelir", "Gider"])
        with col2:
            kategori = st.selectbox("Kategori", [
                "GiriÅŸ Ãœcreti", "ÃœrÃ¼n SatÄ±ÅŸÄ±", "FotoÄŸraf Ã‡ekimi", 
                "Ä°ÅŸÃ§ilik/Yevmiye", "GÃ¼bre/Ä°laÃ§", "Elektrik/Su", "Pazarlama", "DiÄŸer"
            ])
            odeme = st.selectbox("Ã–deme YÃ¶ntemi", ["Nakit", "Kredi KartÄ±", "Havale/EFT"])
            
        tutar = st.number_input("Tutar (TL)", min_value=0.0, step=10.0)
        aciklama = st.text_area("Notlar / Detaylar")
        
        submit = st.form_submit_button("Kaydet")
        
        if submit:
            c = conn.cursor()
            c.execute("INSERT INTO islemler (tarih, tip, kategori, odeme_yontemi, tutar, aciklama) VALUES (?,?,?,?,?,?)",
                      (tarih, tip, kategori, odeme, tutar, aciklama))
            conn.commit()
            st.success(f"KayÄ±t baÅŸarÄ±yla eklendi! ({tarih})")

elif choice == "Mali Raporlar":
    st.subheader("ğŸ“Š Mali Durum Analizi")
    df = pd.read_sql_query("SELECT * FROM islemler", conn)
    
    if not df.empty:
        # Ã–zet KartlarÄ±
        toplam_gelir = df[df['tip'] == 'Gelir']['tutar'].sum()
        toplam_gider = df[df['tip'] == 'Gider']['tutar'].sum()
        net_kar = toplam_gelir - toplam_gider
        
        c1, c2, c3 = st.columns(3)
        c1.metric("Toplam Gelir", f"{toplam_gelir:,.2f} TL")
        c2.metric("Toplam Gider", f"{toplam_gider:,.2f} TL")
        c3.metric("Net Kar", f"{net_kar:,.2f} TL", delta=net_kar)

        # Grafik
        st.write("### Kategori BazlÄ± DaÄŸÄ±lÄ±m")
        chart_data = df.groupby(['tip', 'kategori'])['tutar'].sum().unstack(fill_value=0)
        st.bar_chart(chart_data)
        
        st.write("### TÃ¼m Ä°ÅŸlemler")
        st.dataframe(df.sort_values(by="tarih", ascending=False))
    else:
        st.info("HenÃ¼z veri girilmemiÅŸ.")

elif choice == "KayÄ±tlarÄ± DÃ¼zenle":
    st.subheader("ğŸ“ KayÄ±t YÃ¶netimi")
    df = pd.read_sql_query("SELECT * FROM islemler", conn)
    st.write("Buradan kayÄ±tlarÄ± gÃ¶rÃ¼ntÃ¼leyebilir ve Excel olarak dÄ±ÅŸa aktarabilirsiniz.")
    st.dataframe(df)
    
    # Excel Ã‡Ä±ktÄ±sÄ± Alma
    if st.button("TÃ¼m Verileri Excel Olarak Ä°ndir"):
        df.to_excel("lavanta_bahcesi_yedek.xlsx", index=False)
        st.success("Yedek oluÅŸturuldu: lavanta_bahcesi_yedek.xlsx")